name: CD Pipeline

# on:
#   workflow_run:
#     workflows: ["CI Pipeline"]  
#     types:
#       - completed  # Trigger deployment when CI is complete and successful
#   workflow_dispatch:
 

on:
  workflow_dispatch:  # Allows manual triggering of the workflow

jobs:
  ssh-test:
    runs-on: macos-latest # GitHub-hosted Linux runner

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Set up SSH connection to your Mac using the SSH key stored in GitHub Secrets
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_MAC_KEY }}  # Use SSH_MAC_KEY here

      # Test SSH connection to your Mac
      - name: Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no dhanasekarsubramaniam@192.168.0.146 "echo 'SSH connection successful!'"

      # - name: Deploy Secrets and pvc
      #   run: |
      #     ssh fastapi_user@192.168.0.110 "kubectl apply -f /k8s/secrets/db-secrets.yml"
      #     ssh fastapi_user@192.168.0.110 "kubectl apply -f /path/to/k8s/mariadb/db-pv-claim"
      
      # - name: Deploy MariaDB
      #   run: |
      #     ssh fastapi_user@192.168.0.110 "kubectl apply -f /k8s/mariadb/db-deployment.yml"
      #     ssh fastapi_user@192.168.0.110 "kubectl apply -f /k8s/mariadb/db-service.yml"

      # - name: Deploy FastAPI App
      #   run: |
      #     ssh fastapi_user@192.168.0.110 "kubectl apply -f /k8s/api/fastapi-app-deployment.yml"
      #     ssh fastapi_user@192.168.0.110 "kubectl apply -f /k8s/api/fastapi-app-service.yml"

      # - name: Deploy Alembic Migrations
      #   run: |
      #     ssh fastapi_user@192.168.0.110 "kubectl apply -f /k8s/alembic/alembic-migration.yml"

      # - name: Deploy Ngnix
      #   run: |
      #     ssh fastapi_user@192.168.0.110 "kubectl apply -f /k8s/nginx/ngnix-deployment.yml"
      #     ssh fastapi_user@192.168.0.110 "kubectl apply -f /k8s/nginx/ngnix-service.yml"
